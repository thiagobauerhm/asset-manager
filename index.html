<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H&M BT NA Op's Asset Management</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React and ReactDOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    @media print {
      body * {
        visibility: hidden;
      }
      #qr-print-area, #qr-print-area * {
        visibility: visible;
      }
      #qr-print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <div id="qr-print-area" style="display: none;"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Plus, Search, QrCode, Package, CheckCircle, XCircle, Wrench, Calendar, Edit2, Trash2, Download, Upload, Save, Home, Moon, Sun } = lucide;

    // SharePoint Storage Integration
    const SharePointStorage = {
      config: {
        siteUrl: localStorage.getItem('sharepoint_site_url') || '',
        filePath: localStorage.getItem('sharepoint_file_path') || '',
        enabled: localStorage.getItem('sharepoint_enabled') === 'true'
      },

      setConfig(siteUrl, filePath) {
        this.config.siteUrl = siteUrl;
        this.config.filePath = filePath;
        this.config.enabled = true;
        localStorage.setItem('sharepoint_site_url', siteUrl);
        localStorage.setItem('sharepoint_file_path', filePath);
        localStorage.setItem('sharepoint_enabled', 'true');
      },

      async fetchData() {
        if (!this.config.enabled) return null;
        
        try {
          const response = await fetch(`${this.config.siteUrl}/_api/web/GetFileByServerRelativeUrl('${this.config.filePath}')/$value`, {
            method: 'GET',
            headers: {
              'Accept': 'application/json;odata=verbose'
            },
            credentials: 'include'
          });

          if (response.ok) {
            const text = await response.text();
            return JSON.parse(text);
          }
          return null;
        } catch (error) {
          console.error('SharePoint fetch error:', error);
          return null;
        }
      },

      async saveData(data) {
        if (!this.config.enabled) return false;

        try {
          const response = await fetch(`${this.config.siteUrl}/_api/web/GetFileByServerRelativeUrl('${this.config.filePath}')/$value`, {
            method: 'PUT',
            headers: {
              'Accept': 'application/json;odata=verbose',
              'Content-Type': 'application/json',
              'X-HTTP-Method': 'PUT'
            },
            credentials: 'include',
            body: JSON.stringify(data)
          });

          return response.ok;
        } catch (error) {
          console.error('SharePoint save error:', error);
          return false;
        }
      }
    };

    // Storage wrapper with SharePoint and localStorage fallback
    const storage = {
      async get(key) {
        // Try SharePoint first if enabled
        if (SharePointStorage.config.enabled) {
          const data = await SharePointStorage.fetchData();
          if (data && data[key]) {
            return { key, value: JSON.stringify(data[key]) };
          }
        }

        // Fallback to localStorage
        const value = localStorage.getItem(key);
        if (value) {
          return { key, value };
        }
        return null;
      },
      
      async set(key, value) {
        // Save to localStorage first (immediate)
        localStorage.setItem(key, value);

        // Try SharePoint if enabled
        if (SharePointStorage.config.enabled) {
          const currentData = await SharePointStorage.fetchData() || {};
          currentData[key] = JSON.parse(value);
          currentData.lastModified = new Date().toISOString();
          await SharePointStorage.saveData(currentData);
        }

        return true;
      },
      
      async delete(key) {
        localStorage.removeItem(key);

        if (SharePointStorage.config.enabled) {
          const currentData = await SharePointStorage.fetchData() || {};
          delete currentData[key];
          currentData.lastModified = new Date().toISOString();
          await SharePointStorage.saveData(currentData);
        }

        return true;
      }
    };

    // Helper function to format dates correctly without timezone shift
    const formatDate = (dateString) => {
      if (!dateString) return '';
      const date = new Date(dateString + 'T00:00:00');
      return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        timeZone: 'UTC'
      });
    };

    // QR Code Modal Component
    const QRCodeModal = ({ asset, onClose }) => {
      useEffect(() => {
        lucide.createIcons();
      }, []);

      const printQR = () => {
        const printArea = document.getElementById('qr-print-area');
        printArea.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">${asset.name}</h2>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(asset.name)}" 
                 alt="QR Code" 
                 style="margin: 0 auto; display: block;"/>
          </div>
        `;
        printArea.style.display = 'block';
        window.print();
        printArea.style.display = 'none';
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg max-w-md w-full">
            <div className="p-6 border-b border-gray-200">
              <h2 className="text-2xl font-bold text-gray-900">QR Code</h2>
              <p className="text-sm text-gray-600 mt-1">{asset.name}</p>
            </div>
            <div className="p-6 flex flex-col items-center">
              <img 
                src={`https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(asset.name)}`}
                alt="QR Code"
                className="mb-4"
              />
              <p className="text-sm text-gray-600 text-center mb-4">
                Scan this QR code to view asset details
              </p>
              <button
                onClick={printQR}
                className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors mb-2"
              >
                Print QR Code (Ctrl+P / Cmd+P)
              </button>
              <button
                onClick={onClose}
                className="w-full bg-gray-200 text-gray-800 py-2 rounded-lg hover:bg-gray-300 transition-colors"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Map Modal Component
    const MapModal = ({ address, onClose, theme }) => {
      useEffect(() => {
        lucide.createIcons();
      }, []);

      const mapUrl = `https://www.google.com/maps?q=${encodeURIComponent(address)}&output=embed`;

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className={`${theme === 'dark' ? 'bg-gray-800' : 'bg-white'} rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden`}>
            <div className={`p-4 ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} border-b flex items-center justify-between`}>
              <h2 className={`text-xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Location Map</h2>
              <button
                onClick={onClose}
                className={`p-2 ${theme === 'dark' ? 'hover:bg-gray-700 text-gray-400' : 'hover:bg-gray-100 text-gray-500'} rounded-lg transition-colors`}
              >
                <i data-lucide="x-circle" className="w-6 h-6"></i>
              </button>
            </div>
            <div className="p-4">
              <p className={`text-sm ${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'} mb-4`}>{address}</p>
              <iframe
                src={mapUrl}
                width="100%"
                height="500"
                style={{ border: 0 }}
                allowFullScreen=""
                loading="lazy"
                referrerPolicy="no-referrer-when-downgrade"
                className="rounded-lg"
              ></iframe>
            </div>
          </div>
        </div>
      );
    };

    // Main Asset Manager Component
    const AssetManager = () => {
      const [sites, setSites] = useState([]);
      const [currentSite, setCurrentSite] = useState(null);
      const [assets, setAssets] = useState([]);
      const [categories, setCategories] = useState([]);
      const [showAddModal, setShowAddModal] = useState(false);
      const [showEditModal, setShowEditModal] = useState(false);
      const [showMaintenanceModal, setShowMaintenanceModal] = useState(false);
      const [showCheckoutModal, setShowCheckoutModal] = useState(false);
      const [showSiteModal, setShowSiteModal] = useState(false);
      const [showManageSitesModal, setShowManageSitesModal] = useState(false);
      const [showCategoryModal, setShowCategoryModal] = useState(false);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showColumnSettings, setShowColumnSettings] = useState(false);
      const [showMapModal, setShowMapModal] = useState(false);
      const [showQRModal, setShowQRModal] = useState(false);
      const [showSharePointConfig, setShowSharePointConfig] = useState(false);
      const [mapAddress, setMapAddress] = useState('');
      const [selectedAsset, setSelectedAsset] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterStatus, setFilterStatus] = useState('all');
      const [activeTab, setActiveTab] = useState('inventory');
      const [saveStatus, setSaveStatus] = useState('');
      const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' });
      const [theme, setTheme] = useState('light');
      const [visibleColumns, setVisibleColumns] = useState({
        assetTag: true,
        type: true,
        status: true,
        manufacturer: true,
        model: true,
        serialNumber: true,
        purchaseDate: true,
        endOfLife: true,
        currentUser: true,
        department: true
      });

      // Initialize Lucide icons
      useEffect(() => {
        lucide.createIcons();
      }, [showAddModal, showEditModal, showMaintenanceModal, showCheckoutModal, showSiteModal, showManageSitesModal, showCategoryModal, showExportModal, showColumnSettings, showMapModal, showQRModal, assets, categories, sites, theme]);

      // Check SharePoint configuration on load
      useEffect(() => {
        if (!SharePointStorage.config.enabled) {
          setShowSharePointConfig(true);
        }
      }, []);

      // Load theme
      useEffect(() => {
        const loadTheme = async () => {
          const result = await storage.get('theme');
          if (result && result.value) {
            setTheme(result.value);
          }
        };
        loadTheme();
      }, []);

      // Save theme
      const toggleTheme = async () => {
        const newTheme = theme === 'light' ? 'dark' : 'light';
        setTheme(newTheme);
        await storage.set('theme', newTheme);
      };

      // Load sites from storage
      useEffect(() => {
        const loadSites = async () => {
          try {
            const result = await storage.get('sites');
            if (result && result.value) {
              const loadedSites = JSON.parse(result.value);
              setSites(loadedSites);
              if (loadedSites.length > 0) {
                setCurrentSite(loadedSites[0]);
              }
            }
          } catch (error) {
            console.error('Error loading sites:', error);
          }
        };
        loadSites();
      }, []);

      // Load categories
      useEffect(() => {
        const loadCategories = async () => {
          try {
            const result = await storage.get('categories');
            if (result && result.value) {
              setCategories(JSON.parse(result.value));
            } else {
              // Default categories
              const defaultCategories = [
                { id: '1', name: 'Laptop', icon: 'ðŸ’»' },
                { id: '2', name: 'Desktop', icon: 'ðŸ–¥ï¸' },
                { id: '3', name: 'Monitor', icon: 'ðŸ–¥ï¸' },
                { id: '4', name: 'Printer', icon: 'ðŸ–¨ï¸' },
                { id: '5', name: 'Phone', icon: 'ðŸ“±' },
                { id: '6', name: 'Tablet', icon: 'ðŸ“²' },
                { id: '7', name: 'Zebra Scanner', icon: 'ðŸ¦“' },
              ];
              setCategories(defaultCategories);
              await storage.set('categories', JSON.stringify(defaultCategories));
            }
          } catch (error) {
            console.error('Error loading categories:', error);
          }
        };
        loadCategories();
      }, []);

      // Load column preferences
      useEffect(() => {
        const loadColumnPrefs = async () => {
          const result = await storage.get('columnPreferences');
          if (result && result.value) {
            setVisibleColumns(JSON.parse(result.value));
          }
        };
        loadColumnPrefs();
      }, []);

      // Load assets for current site
      useEffect(() => {
        const loadAssets = async () => {
          if (!currentSite) return;
          try {
            const result = await storage.get(`assets_${currentSite.id}`);
            if (result && result.value) {
              setAssets(JSON.parse(result.value));
            } else {
              setAssets([]);
            }
          } catch (error) {
            console.error('Error loading assets:', error);
          }
        };
        loadAssets();
      }, [currentSite]);

      const saveSites = async (updatedSites) => {
        await storage.set('sites', JSON.stringify(updatedSites));
        setSites(updatedSites);
      };

      const saveAssets = async (updatedAssets) => {
        if (!currentSite) return;
        await storage.set(`assets_${currentSite.id}`, JSON.stringify(updatedAssets));
        setAssets(updatedAssets);
        showSaveFeedback();
      };

      const saveColumnPreferences = async (prefs) => {
        setVisibleColumns(prefs);
        await storage.set('columnPreferences', JSON.stringify(prefs));
        setShowColumnSettings(false);
      };

      const showSaveFeedback = (message = 'âœ“ Saved') => {
        setSaveStatus(message);
        setTimeout(() => setSaveStatus(''), 2000);
      };

      const addSite = async (siteData) => {
        const newSite = {
          id: Date.now().toString(),
          ...siteData,
          createdAt: new Date().toISOString()
        };
        const updatedSites = [...sites, newSite];
        await saveSites(updatedSites);
        if (!currentSite) {
          setCurrentSite(newSite);
        }
        setShowSiteModal(false);
      };

      const switchSite = (site) => {
        setCurrentSite(site);
        setShowManageSitesModal(false);
      };

      const deleteSite = async (siteId) => {
        if (sites.length === 1) {
          alert('Cannot delete the last site!');
          return;
        }
        if (currentSite && currentSite.id === siteId) {
          alert('Cannot delete the currently selected site! Please switch to another site first.');
          return;
        }
        if (confirm('Are you sure you want to delete this site and all its assets?')) {
          await storage.delete(`assets_${siteId}`);
          const updatedSites = sites.filter(s => s.id !== siteId);
          await saveSites(updatedSites);
        }
      };

      const addCategory = async (category) => {
        const newCategory = { id: Date.now().toString(), ...category };
        const updatedCategories = [...categories, newCategory];
        setCategories(updatedCategories);
        await storage.set('categories', JSON.stringify(updatedCategories));
      };

      const updateCategory = async (categoryId, updates) => {
        const updatedCategories = categories.map(c => 
          c.id === categoryId ? { ...c, ...updates } : c
        );
        setCategories(updatedCategories);
        await storage.set('categories', JSON.stringify(updatedCategories));
      };

      const deleteCategory = async (categoryId) => {
        const usedInAssets = assets.some(a => a.categoryId === categoryId);
        if (usedInAssets) {
          alert('Cannot delete category - it is being used by one or more assets!');
          return;
        }
        if (categories.length === 1) {
          alert('Cannot delete the last category!');
          return;
        }
        const updatedCategories = categories.filter(c => c.id !== categoryId);
        setCategories(updatedCategories);
        await storage.set('categories', JSON.stringify(updatedCategories));
      };

      const addAsset = (assetData) => {
        const newAsset = {
          id: Date.now().toString(),
          ...assetData,
          status: 'available',
          maintenanceHistory: [],
          checkoutHistory: [],
          createdAt: new Date().toISOString()
        };
        const updatedAssets = [...assets, newAsset];
        saveAssets(updatedAssets);
        setShowAddModal(false);
      };

      const editAsset = (updatedData) => {
        const updatedAssets = assets.map(asset =>
          asset.id === selectedAsset.id ? { ...asset, ...updatedData } : asset
        );
        saveAssets(updatedAssets);
        setShowEditModal(false);
        setSelectedAsset(null);
      };

      const updateAsset = (assetId, updatedAsset) => {
        const updatedAssets = assets.map(asset =>
          asset.id === assetId ? updatedAsset : asset
        );
        saveAssets(updatedAssets);
      };

      const deleteAsset = (assetId) => {
        if (confirm('Are you sure you want to delete this asset?')) {
          const updatedAssets = assets.filter(asset => asset.id !== assetId);
          saveAssets(updatedAssets);
        }
      };

      const addMaintenance = (assetId, maintenanceData) => {
        const asset = assets.find(a => a.id === assetId);
        const updatedAsset = {
          ...asset,
          maintenanceHistory: [
            ...asset.maintenanceHistory,
            { ...maintenanceData, id: Date.now().toString(), date: new Date().toISOString() }
          ]
        };
        updateAsset(assetId, updatedAsset);
        setSelectedAsset(updatedAsset);
      };

      const checkOut = (assetId, checkoutData) => {
        const asset = assets.find(a => a.id === assetId);
        const updatedAsset = {
          ...asset,
          status: 'checked-out',
          currentUser: checkoutData.userName,
          department: checkoutData.department,
          checkoutDate: new Date().toISOString(),
          expectedReturn: checkoutData.expectedReturn,
          checkoutHistory: [
            ...asset.checkoutHistory,
            { ...checkoutData, checkoutDate: new Date().toISOString(), id: Date.now().toString() }
          ]
        };
        updateAsset(assetId, updatedAsset);
        setShowCheckoutModal(false);
        setSelectedAsset(null);
      };

      const checkIn = (assetId) => {
        const asset = assets.find(a => a.id === assetId);
        const updatedAsset = {
          ...asset,
          status: 'available',
          currentUser: '',
          department: '',
          checkoutDate: null,
          expectedReturn: null
        };
        updateAsset(assetId, updatedAsset);
      };

      const handleSort = (key) => {
        let direction = 'asc';
        if (sortConfig.key === key && sortConfig.direction === 'asc') {
          direction = 'desc';
        }
        setSortConfig({ key, direction });
      };

      const sortedAndFilteredAssets = () => {
        let filtered = assets.filter(asset => {
          const matchesSearch = asset.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                               asset.serialNumber?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                               asset.manufacturer?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                               asset.model?.toLowerCase().includes(searchTerm.toLowerCase());
          const matchesStatus = filterStatus === 'all' || asset.status === filterStatus;
          return matchesSearch && matchesStatus;
        });

        if (sortConfig.key) {
          filtered.sort((a, b) => {
            let aVal = a[sortConfig.key];
            let bVal = b[sortConfig.key];

            if (aVal === null || aVal === undefined) aVal = '';
            if (bVal === null || bVal === undefined) bVal = '';

            if (typeof aVal === 'string') aVal = aVal.toLowerCase();
            if (typeof bVal === 'string') bVal = bVal.toLowerCase();

            if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
          });
        }

        return filtered;
      };

      const getStatusColor = (status) => {
        switch (status) {
          case 'available': return 'bg-green-100 text-green-800';
          case 'checked-out': return 'bg-yellow-100 text-yellow-800';
          case 'maintenance': return 'bg-red-100 text-red-800';
          default: return 'bg-gray-100 text-gray-800';
        }
      };

      const getDashboardStats = () => {
        const total = assets.length;
        const available = assets.filter(a => a.status === 'available').length;
        const checkedOut = assets.filter(a => a.status === 'checked-out').length;
        
        const today = new Date();
        const ninetyDaysFromNow = new Date(today.getTime() + (90 * 24 * 60 * 60 * 1000));
        
        const nearEOL = assets.filter(asset => {
          if (!asset.endOfLife) return false;
          const eolDate = new Date(asset.endOfLife);
          return eolDate <= ninetyDaysFromNow;
        });

        return { total, available, checkedOut, nearEOL };
      };

      const stats = getDashboardStats();

      return (
        <div className={`min-h-screen ${theme === 'dark' ? 'dark bg-gray-900' : 'bg-gray-50'}`}>
          <div className="max-w-[95%] mx-auto p-6">
            <div className={`${theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded-lg shadow-sm border mb-6 p-6`}>
              <div className="flex items-center justify-between">
                <div>
                  <h1 className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'} flex items-center gap-2`}>
                    <img 
                      src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/H%26M-Logo.svg/709px-H%26M-Logo.svg.png" 
                      alt="H&M" 
                      className="h-8"
                    />
                    BT NA Op's Asset Management
                    {saveStatus && (
                      <span className="text-sm text-green-600 ml-4">{saveStatus}</span>
                    )}
                  </h1>
                  <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mt-1`}>Track and manage our IT equipment</p>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    onClick={toggleTheme}
                    className={`${theme === 'dark' ? 'bg-gray-700 text-yellow-400 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-4 py-2 rounded-lg flex items-center gap-2 transition-colors`}
                  >
                    <i data-lucide={theme === 'dark' ? 'sun' : 'moon'} className="w-5 h-5"></i>
                  </button>
                  <button
                    onClick={() => setShowSharePointConfig(true)}
                    className={`${theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} px-4 py-2 rounded-lg flex items-center gap-2 transition-colors`}
                  >
                    <i data-lucide="settings" className="w-5 h-5"></i>
                    SharePoint
                  </button>
                  <button
                    onClick={() => setShowExportModal(true)}
                    className={`${theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-blue-600 text-white hover:bg-blue-700'} px-4 py-2 rounded-lg flex items-center gap-2 transition-colors`}
                  >
                    <i data-lucide="download" className="w-5 h-5"></i>
                    Backup
                  </button>
                  <button
                    onClick={() => setShowManageSitesModal(true)}
                    className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
                  >
                    <i data-lucide="home" className="w-5 h-5"></i>
                    Manage Sites
                  </button>
                </div>
              </div>

              {/* Current Site Selector */}
              <div className="mt-6">
                {currentSite ? (
                  <div className={`${theme === 'dark' ? 'bg-gray-700' : 'bg-white'} rounded-lg p-4 border ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'}`}>
                    <div className="flex items-center justify-between">
                      <div>
                        <div className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Current Site</div>
                        <div className={`text-lg font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>
                          {currentSite.siteId} - {currentSite.name} - {currentSite.costCenter}
                        </div>
                        {currentSite.location && (
                          <button
                            onClick={() => {
                              setMapAddress(currentSite.location);
                              setShowMapModal(true);
                            }}
                            className={`text-sm ${theme === 'dark' ? 'text-blue-400 hover:text-blue-300' : 'text-blue-600 hover:text-blue-800'} underline mt-1`}
                          >
                            {currentSite.location}
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className={`${theme === 'dark' ? 'bg-gray-700' : 'bg-gray-50'} rounded-lg p-6 border ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} text-center`}>
                    <p className={`${theme === 'dark' ? 'text-gray-300' : 'text-gray-600'} mb-4`}>No sites created yet. Create your first site to get started!</p>
                    <button
                      onClick={() => setShowManageSitesModal(true)}
                      className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors"
                    >
                      Create Site
                    </button>
                  </div>
                )}
              </div>

              {/* Search and Filter */}
              {currentSite && (
                <div className="mt-6 flex gap-4">
                  <div className="flex-1 relative">
                    <i data-lucide="search" className={`absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 ${theme === 'dark' ? 'text-gray-400' : 'text-gray-400'}`}></i>
                    <input
                      type="text"
                      placeholder="Search assets..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className={`w-full pl-10 pr-4 py-2 border ${theme === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
                    />
                  </div>
                  <select
                    value={filterStatus}
                    onChange={(e) => setFilterStatus(e.target.value)}
                    className={`px-4 py-2 border ${theme === 'dark' ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent`}
                  >
                    <option value="all">All Status</option>
                    <option value="available">Available</option>
                    <option value="checked-out">Checked Out</option>
                    <option value="maintenance">Maintenance</option>
                  </select>
                  <button
                    onClick={() => setShowCategoryModal(true)}
                    className={`px-4 py-2 ${theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} rounded-lg transition-colors`}
                  >
                    Manage Categories
                  </button>
                </div>
              )}
            </div>

            {/* Dashboard Stats */}
            {currentSite && (
              <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div className={`${theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded-lg shadow-sm border p-6`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Total Assets</p>
                      <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'} mt-1`}>{stats.total}</p>
                    </div>
                    <i data-lucide="package" className="w-12 h-12 text-blue-500"></i>
                  </div>
                </div>

                <div className={`${theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded-lg shadow-sm border p-6`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Available</p>
                      <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'} mt-1`}>{stats.available}</p>
                    </div>
                    <i data-lucide="check-circle" className="w-12 h-12 text-green-500"></i>
                  </div>
                </div>

                <div className={`${theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded-lg shadow-sm border p-6`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>Checked Out</p>
                      <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'} mt-1`}>{stats.checkedOut}</p>
                    </div>
                    <i data-lucide="calendar" className="w-12 h-12 text-yellow-500"></i>
                  </div>
                </div>

                <div className={`${theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded-lg shadow-sm border p-6`}>
                  <div className="flex items-center justify-between">
                    <div>
                      <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'}`}>EOL Devices</p>
                      <p className={`text-3xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'} mt-1`}>{stats.nearEOL.length}</p>
                    </div>
                    <i data-lucide="alert-triangle" className="w-12 h-12 text-red-500"></i>
                  </div>
                  {stats.nearEOL.length > 0 && (
                    <div className="mt-4">
                      <div className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} max-h-24 overflow-y-auto`}>
                        {stats.nearEOL.slice(0, 6).map(asset => (
                          <div key={asset.id} className="text-red-600">
                            â€¢ {asset.name} | {asset.serialNumber}
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Asset Inventory Table */}
            {currentSite && (
              <div className={`${theme === 'dark' ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} rounded-lg shadow-sm border`}>
                <div className={`p-6 ${theme === 'dark' ? 'border-gray-700' : 'border-gray-200'} border-b flex items-center justify-between`}>
                  <h2 className={`text-xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>Asset Inventory</h2>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowAddModal(true)}
                      className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 text-sm"
                    >
                      <i data-lucide="plus" className="w-4 h-4"></i>
                      Add Asset
                    </button>
                    <button
                      onClick={() => setShowColumnSettings(true)}
                      className={`px-4 py-2 ${theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} rounded-lg transition-colors text-sm`}
                    >
                      Customize Columns
                    </button>
                  </div>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-sm">
                    <thead className={`${theme === 'dark' ? 'bg-gray-700 border-gray-600' : 'bg-gray-50 border-gray-200'} border-b`}>
                      <tr>
                        <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                            onClick={() => handleSort('name')}>
                          <div className="flex items-center gap-1">
                            Asset Name {sortConfig.key === 'name' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                          </div>
                        </th>
                        {visibleColumns.type && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('type')}>
                            <div className="flex items-center gap-1">
                              Type {sortConfig.key === 'type' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.status && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('status')}>
                            <div className="flex items-center gap-1">
                              Status {sortConfig.key === 'status' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.manufacturer && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('manufacturer')}>
                            <div className="flex items-center gap-1">
                              Mfr {sortConfig.key === 'manufacturer' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.model && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('model')}>
                            <div className="flex items-center gap-1">
                              Model {sortConfig.key === 'model' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.serialNumber && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('serialNumber')}>
                            <div className="flex items-center gap-1">
                              Serial # {sortConfig.key === 'serialNumber' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.purchaseDate && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('purchaseDate')}>
                            <div className="flex items-center gap-1">
                              Purchase {sortConfig.key === 'purchaseDate' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.endOfLife && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('endOfLife')}>
                            <div className="flex items-center gap-1">
                              EOL {sortConfig.key === 'endOfLife' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.currentUser && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('currentUser')}>
                            <div className="flex items-center gap-1">
                              User {sortConfig.key === 'currentUser' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        {visibleColumns.department && (
                          <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider cursor-pointer ${theme === 'dark' ? 'hover:bg-gray-600' : 'hover:bg-gray-100'}`}
                              onClick={() => handleSort('department')}>
                            <div className="flex items-center gap-1">
                              Dept {sortConfig.key === 'department' && (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“')}
                            </div>
                          </th>
                        )}
                        <th className={`px-4 py-2 text-left text-xs font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-500'} uppercase tracking-wider`}>
                          Actions
                        </th>
                      </tr>
                    </thead>
                    <tbody className={`${theme === 'dark' ? 'bg-gray-800 divide-gray-700' : 'bg-white divide-gray-200'} divide-y`}>
                      {sortedAndFilteredAssets().map(asset => (
                        <tr key={asset.id} className={`${theme === 'dark' ? 'hover:bg-gray-700' : 'hover:bg-gray-50'}`}>
                          <td className={`px-4 py-3 font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>{asset.name}</td>
                          {visibleColumns.type && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>{asset.type}</td>
                          )}
                          {visibleColumns.status && (
                            <td className="px-4 py-3">
                              <span className={`px-2 py-0.5 text-xs font-medium rounded-full ${getStatusColor(asset.status)}`}>
                                {asset.status.replace('-', ' ').toUpperCase()}
                              </span>
                            </td>
                          )}
                          {visibleColumns.manufacturer && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>{asset.manufacturer || '-'}</td>
                          )}
                          {visibleColumns.model && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>{asset.model || '-'}</td>
                          )}
                          {visibleColumns.serialNumber && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'} font-mono text-xs`}>{asset.serialNumber || '-'}</td>
                          )}
                          {visibleColumns.purchaseDate && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>
                              {asset.purchaseDate ? formatDate(asset.purchaseDate) : '-'}
                            </td>
                          )}
                          {visibleColumns.endOfLife && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>
                              {asset.endOfLife ? formatDate(asset.endOfLife) : '-'}
                            </td>
                          )}
                          {visibleColumns.currentUser && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>{asset.currentUser || '-'}</td>
                          )}
                          {visibleColumns.department && (
                            <td className={`px-4 py-3 ${theme === 'dark' ? 'text-gray-300' : 'text-gray-900'}`}>{asset.department || '-'}</td>
                          )}
                          <td className="px-4 py-3">
                            <div className="flex items-center gap-1">
                              <button
                                onClick={() => {
                                  setSelectedAsset(asset);
                                  setShowEditModal(true);
                                }}
                                className="p-1 text-blue-600 hover:bg-blue-50 rounded transition-colors"
                                title="Edit"
                              >
                                <i data-lucide="edit-2" className="w-4 h-4"></i>
                              </button>
                              <button
                                onClick={() => {
                                  setSelectedAsset(asset);
                                  setShowQRModal(true);
                                }}
                                className="p-1 text-purple-600 hover:bg-purple-50 rounded transition-colors"
                                title="QR Code"
                              >
                                <i data-lucide="qr-code" className="w-4 h-4"></i>
                              </button>
                              <button
                                onClick={() => {
                                  setSelectedAsset(asset);
                                  setShowMaintenanceModal(true);
                                }}
                                className="p-1 text-orange-600 hover:bg-orange-50 rounded transition-colors"
                                title="Maintenance"
                              >
                                <i data-lucide="wrench" className="w-4 h-4"></i>
                              </button>
                              {asset.status === 'available' ? (
                                <button
                                  onClick={() => {
                                    setSelectedAsset(asset);
                                    setShowCheckoutModal(true);
                                  }}
                                  className="p-1 text-green-600 hover:bg-green-50 rounded transition-colors"
                                  title="Check Out"
                                >
                                  <i data-lucide="check-circle" className="w-4 h-4"></i>
                                </button>
                              ) : (
                                <button
                                  onClick={() => checkIn(asset.id)}
                                  className="p-1 text-yellow-600 hover:bg-yellow-50 rounded transition-colors"
                                  title="Check In"
                                >
                                  <i data-lucide="x-circle" className="w-4 h-4"></i>
                                </button>
                              )}
                              <button
                                onClick={() => deleteAsset(asset.id)}
                                className="p-1 text-red-600 hover:bg-red-50 rounded transition-colors"
                                title="Delete"
                              >
                                <i data-lucide="trash-2" className="w-4 h-4"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  {sortedAndFilteredAssets().length === 0 && (
                    <div className="text-center py-12">
                      <p className={`${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'}`}>No assets found</p>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Modals and Overlays */}
            {showQRModal && selectedAsset && (
              <QRCodeModal asset={selectedAsset} onClose={() => { setShowQRModal(false); setSelectedAsset(null); }} />
            )}
            {showMapModal && (
              <MapModal address={mapAddress} onClose={() => setShowMapModal(false)} theme={theme} />
            )}
            {showSharePointConfig && (
              <SharePointConfigModal onClose={() => setShowSharePointConfig(false)} theme={theme} />
            )}
          </div>

          {/* Note: Additional modals (Add, Edit, Maintenance, etc.) would be rendered here */}
          {/* For the standalone version, core modals are included. Full modal components can be added as needed. */}
        </div>
      );
    };

    // SharePoint Configuration Modal
    const SharePointConfigModal = ({ onClose, theme }) => {
      const [siteUrl, setSiteUrl] = useState(SharePointStorage.config.siteUrl);
      const [filePath, setFilePath] = useState(SharePointStorage.config.filePath);

      const handleSave = () => {
        if (siteUrl && filePath) {
          SharePointStorage.setConfig(siteUrl, filePath);
          alert('SharePoint configuration saved! The app will now use SharePoint for data storage.');
          onClose();
          window.location.reload();
        } else {
          alert('Please fill in both fields');
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className={`${theme === 'dark' ? 'bg-gray-800' : 'bg-white'} rounded-lg max-w-2xl w-full`}>
            <div className={`p-6 ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} border-b`}>
              <h2 className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-900'}`}>SharePoint Configuration</h2>
              <p className={`text-sm ${theme === 'dark' ? 'text-gray-400' : 'text-gray-600'} mt-2`}>
                Configure SharePoint to enable data sharing across your team.
              </p>
            </div>
            <div className="p-6 space-y-4">
              <div>
                <label className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-1`}>
                  SharePoint Site URL *
                </label>
                <input
                  type="text"
                  value={siteUrl}
                  onChange={(e) => setSiteUrl(e.target.value)}
                  placeholder="https://yourcompany.sharepoint.com/sites/YourTeam"
                  className={`w-full px-3 py-2 border ${theme === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'} rounded-lg focus:ring-2 focus:ring-blue-500`}
                />
              </div>
              <div>
                <label className={`block text-sm font-medium ${theme === 'dark' ? 'text-gray-300' : 'text-gray-700'} mb-1`}>
                  Data File Path *
                </label>
                <input
                  type="text"
                  value={filePath}
                  onChange={(e) => setFilePath(e.target.value)}
                  placeholder="/sites/YourTeam/Shared Documents/AssetManagerData/asset-data.json"
                  className={`w-full px-3 py-2 border ${theme === 'dark' ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300 text-gray-900'} rounded-lg focus:ring-2 focus:ring-blue-500`}
                />
                <p className={`text-xs ${theme === 'dark' ? 'text-gray-400' : 'text-gray-500'} mt-1`}>
                  Create this file in SharePoint first with initial content: {'{}'} 
                </p>
              </div>
              <div className={`p-4 ${theme === 'dark' ? 'bg-gray-700' : 'bg-blue-50'} rounded-lg`}>
                <h3 className={`text-sm font-semibold ${theme === 'dark' ? 'text-white' : 'text-blue-900'} mb-2`}>Quick Setup:</h3>
                <ol className={`text-xs ${theme === 'dark' ? 'text-gray-300' : 'text-blue-800'} space-y-1 list-decimal list-inside`}>
                  <li>Go to your SharePoint site Documents library</li>
                  <li>Create folder: AssetManagerData</li>
                  <li>Create file: asset-data.json (with content: {})</li>
                  <li>Copy the SharePoint site URL and file path above</li>
                  <li>Click Save Configuration</li>
                </ol>
              </div>
            </div>
            <div className={`p-6 ${theme === 'dark' ? 'border-gray-600' : 'border-gray-200'} border-t flex gap-3`}>
              <button
                onClick={handleSave}
                className="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                Save Configuration
              </button>
              <button
                onClick={onClose}
                className={`flex-1 ${theme === 'dark' ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'} py-2 rounded-lg transition-colors`}
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<AssetManager />);

    // Initialize Lucide icons on load
    lucide.createIcons();
  </script>
</body>
</html>
